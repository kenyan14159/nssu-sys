# Nit-Sys 包括的システム監査レポート

**担当:** シニアフルスタック・アーキテクト & セキュリティスペシャリスト
**日付:** 2025年12月19日
**対象:** Nit-Sys v1.0.0 (COMPREHENSIVE.md)

---

## 1. 総合スコアとエグゼクティブサマリー

### 総合スコア: **82 / 100**

### エグゼクティブサマリー
Nit-Sys v1.0.0は、Djangoのベストプラクティスを遵守した堅実な設計であり、初期リリースとしては高い完成度（94%の実装率）を誇ります。特に、ディレクトリ構成の明確さ、CI/CDパイプラインの整備、および`render.yaml`によるIaC化は高く評価できます（**良い点: 2割**）。

しかし、長距離競技会という「特定日時にアクセスと処理が集中する」特性を考慮すると、現在のナイーブな実装（ループ内でのDB保存処理など）では、参加者数が増加した際にシステムダウンや著しいパフォーマンス低下を招くリスクがあります。また、フロントエンドがVanilla JSに依存しており、保守性と現代的なUXの観点で「技術的負債」になりつつあります。これらを解消し、実運用での堅牢性を保証するためには、以下の改善が必須です（**懸念点: 8割**）。

---

## 2. 致命的・重点改善項目 (Critical / Major)

| 優先度 | カテゴリ | 現状の課題 | 具体的な解決策・推奨技術 | 期待効果 |
| :--- | :--- | :--- | :--- | :--- |
| **Critical** | **Scalability** | `HeatGenerator`や`NCG`処理でのループ内 `save()` / `create()` | **`bulk_create` / `bulk_update` の導入**。<br>DjangoのORM最適化を行い、N+1問題を回避する。 | 編成処理時間を数分から数秒へ短縮。<br>DB負荷の劇的低減。 |
| **Critical** | **Security** | `settings.py` の `SECRET_KEY` 等が環境変数依存だが、デフォルト値がハードコードされている | **`django-environ` での厳格化**。<br>本番環境で環境変数が欠落している場合、起動自体を停止させるフェイルセーフを導入。 | 設定ミスによるセキュリティ事故の完全防止。 |
| **Major** | **UX/UI** | Vanilla JSによる手書きのDOM操作（Toast, Loading等） | **Alpine.js + HTMX の導入**。<br>宣言的な記述によりJSコード量を70%削減し、SPA風の快適な操作感を提供。 | コード保守性の向上。<br>スマホでの操作感（点呼等）の劇的改善。 |
| **Major** | **DevOps** | DBバックアップ戦略の明記がない | **RenderのPoint-in-Time Recovery (PITR) 確認**。<br>または`django-db-backup`によるS3への定期ダンプ自動化。 | データ消失事故からの確実な復旧。 |

---

## 3. 深掘りレビューとネクストステップ

### 3.1 セキュリティ・個人情報保護の強化 (Security & PII)

現状の `accounts` アプリは最低限の機能を有していますが、個人情報保護の観点で強化が必要です。

*   **監査ログの強化**: `django-auditlog` は導入されていますが、重要な操作（入金承認、選手データの変更、**特にCSVエクスポート**）に対してログが確実に記録されているか再確認が必要です。誰がいつ名簿を持ち出したかを追跡可能にする必要があります。
*   **セッション管理**: `SESSION_COOKIE_AGE = 86400` (24時間) は、共用PCを利用する学生管理者にとって長すぎます。`SESSION_IDLE_TIMEOUT` (30分) が機能しているか、ミドルウェアの順序を含めて検証してください。
*   **WAFの導入**: Renderの前段に **Cloudflare** を配置することを強く推奨します。DDoS攻撃対策およびボットによる不正エントリー防止に効果的です。

### 3.2 パフォーマンスとスケーラビリティ (Scalability & Performance)

最も懸念される領域です。

*   **編成ロジックの最適化**:
    `heats/models.py` の `generate_heats` メソッドにおいて、`HitAssignment.objects.create(...)` がループ内で実行されています。参加者が1000人の場合、1000回のINSERTクエリが発行されます。
    *   **修正案**: リストにオブジェクトを格納し、`HeatAssignment.objects.bulk_create(assignments)` を使用してください。
*   **NCGスライド処理**:
    `process_ncg_entries` も同様に1件ずつ `save()` しています。これも `bulk_update` で一括更新すべきです。
*   **非同期処理の検討**:
    編成処理やPDF生成は、Webサーバー（Gunicorn）のタイムアウト（通常30秒〜60秒）に引っかかる可能性があります。
    *   **修正案**: **Celery** または **Redis Queue (RQ)** を導入し、重い処理をバックグラウンドワーカーにオフロードすることを検討してください（Version 2.0での必須要件）。

### 3.3 UX/UI とモダン化 (Modern UX)

`templates/base.html` のCSS/JSは、今後の拡張でカオス化する恐れがあります。

*   **脱Vanilla JS**:
    現在の `window.NitSys.toast` や `pageLoading` などの実装は、より堅牢なライブラリに置き換えるべきです。**Alpine.js** を使えば、HTML内にロジックを宣言的に記述でき、見通しが良くなります。
*   **部分更新 (HTMX)**:
    「当日点呼」機能において、チェックインのトグルで画面全体をリロードするのはUXとして致命的です。**HTMX** (`hx-post`, `hx-swap="outerHTML"`) を導入し、サーバーと通信してボタン部分だけを置換する実装に変更してください。スマホでの連続タップに耐えうるUIになります。
*   **アセット管理**:
    CSS/JSがテンプレート内に直書きされている箇所が見受けられます。これらは `static` フォルダへ移動し、`django-compressor` 等で結合・圧縮するパイプラインを整備してください。

### 3.4 DevOps と保守性

*   **Lint/Formatの強制**:
    GitHub Actions での `ruff` 実行は素晴らしいですが、**pre-commit hook** を導入し、コミット前にローカルで強制的に修正させるフローを追加してください。
*   **リリースフロー**:
    本番環境へのデプロイ時、自動的にデータベースのバックアップを取得するステップをCI/CDに組み込むことを推奨します。

---

## 4. 目指すべき「バージョン 2.0」へのロードマップ

システムを「100点」にするための、リリース後の改修ロードマップ案です。

### Phase 1: リリース直後（安定化） - 1ヶ月以内
1.  **DBクエリ最適化**: `bulk_create/update` の全面適用。
2.  **フロントエンドリファクタリング**: `base.html` のJSをAlpine.jsへ移行。
3.  **監視強化**: Sentryに加え、**New Relic** または **Datadog** (APM) でのパフォーマンス監視導入。

### Phase 2: 機能拡張（UX向上） - 3ヶ月以内
1.  **HTMX全面導入**: ダッシュボード、リスト操作のSPAライクな挙動化。
2.  **非同期処理基盤**: Redis + Celery/RQ による帳票生成・メール送信のバックグラウンド化。
3.  **スマホアプリ対応**: PWA (Progressive Web App) 対応のマニフェスト追加。

### Phase 3: アーキテクチャ進化 - 6ヶ月以降
1.  **リアクティブな番組編成UI**: ドラッグ＆ドロップでの組変更を、Vue.js/React等のコンポーネントとして切り出し（Djangoとのハイブリッド化）。
2.  **APIファースト化**: モバイルアプリ開発を見据え、ロジックをDRFのSerializer/Viewsetに完全集約。

---
**結論**:
Nit-Sysは優れたポテンシャルを持っていますが、競技会運営という「失敗が許されない」環境に耐えうるには、**「ループ処理の排除」**と**「フロントエンドの近代化」**が急務です。これらを実行することで、真にプロフェッショナルなシステムへと昇華します。
