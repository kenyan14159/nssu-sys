# 本番運用ガイド

日体大競技会エントリーシステム（NIT-SYS）の本番運用に必要な設定と手順をまとめています。

---

## 目次

1. [デプロイ前チェックリスト](#デプロイ前チェックリスト)
2. [環境変数設定](#環境変数設定)
3. [バックアップ設定](#バックアップ設定)
4. [エラー監視（Sentry）](#エラー監視sentry)
5. [メール設定](#メール設定)
6. [障害対応フロー](#障害対応フロー)

---

## デプロイ前チェックリスト

### 必須項目

- [ ] `DEBUG=False` に設定
- [ ] `SECRET_KEY` を本番用に変更
- [ ] `ALLOWED_HOSTS` に本番ドメインを追加
- [ ] `CSRF_TRUSTED_ORIGINS` に本番ドメインを追加
- [ ] データベース接続確認
- [ ] 静的ファイル収集（`collectstatic`）
- [ ] マイグレーション実行

### 推奨項目

- [ ] Sentry DSN設定
- [ ] メール送信設定
- [ ] バックアップ設定
- [ ] SSL証明書確認

---

## 環境変数設定

### Renderの場合

Render ダッシュボード → Environment で以下を設定:

```
SECRET_KEY=<50文字以上のランダム文字列>
DEBUG=False
ALLOWED_HOSTS=your-app.onrender.com
DATABASE_URL=<Renderが自動設定>
CSRF_TRUSTED_ORIGINS=https://your-app.onrender.com
SENTRY_DSN=https://xxx@sentry.io/xxx
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=<Gmailアプリパスワード>
```

### SECRET_KEY生成方法

```python
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
```

---

## バックアップ設定

### Render PostgreSQL

1. Render ダッシュボード → Database → Settings
2. 「Automatic Backups」を有効化
3. バックアップ頻度: Daily（推奨）
4. 保持期間: 7日以上

### 手動バックアップ

```bash
# ローカルにダンプ
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d).sql

# リストア
psql $DATABASE_URL < backup_20241219.sql
```

---

## エラー監視（Sentry）

### 設定手順

1. [sentry.io](https://sentry.io) でアカウント作成
2. 新規プロジェクト作成（Django選択）
3. DSNをコピー
4. 環境変数に設定:
   ```
   SENTRY_DSN=https://xxx@sentry.io/xxx
   ```

### 動作確認

設定後、以下のコードでテストエラーを送信:

```python
# Django shellで実行
import sentry_sdk
sentry_sdk.capture_message("Test message from NIT-SYS")
```

---

## メール設定

### Gmail（開発・小規模向け）

1. Googleアカウント → セキュリティ → 2段階認証を有効化
2. アプリパスワードを生成
3. 環境変数に設定:
   ```
   EMAIL_HOST=smtp.gmail.com
   EMAIL_PORT=587
   EMAIL_USE_TLS=True
   EMAIL_HOST_USER=your-email@gmail.com
   EMAIL_HOST_PASSWORD=<16桁のアプリパスワード>
   ```

### SendGrid（本番向け）

1. [sendgrid.com](https://sendgrid.com) でアカウント作成
2. API Keyを発行
3. 環境変数に設定:
   ```
   EMAIL_HOST=smtp.sendgrid.net
   EMAIL_PORT=587
   EMAIL_USE_TLS=True
   EMAIL_HOST_USER=apikey
   EMAIL_HOST_PASSWORD=SG.xxxxx
   ```

### 送信テスト

```bash
python manage.py shell
>>> from django.core.mail import send_mail
>>> send_mail('テスト', '本文', 'from@example.com', ['to@example.com'])
```

---

## 障害対応フロー

### レベル1: 軽微な問題（1時間以内）

- ログ確認
- 該当機能の一時停止
- ホットフィックス適用

### レベル2: 中程度の問題（半日以内）

- Sentryでエラー詳細確認
- 影響範囲の特定
- 修正＆テスト＆デプロイ

### レベル3: 重大な障害

1. **即時対応**: サイトをメンテナンスモードに
2. **調査**: ログ・監視データを収集
3. **復旧**: バックアップからリストア or ロールバック
4. **報告**: 関係者への状況報告

### 連絡先

> [!IMPORTANT]
> 本番運用前に以下の連絡先を記入してください。

| 役割 | 担当者名 | メール | 電話 |
|------|----------|--------|------|
| 技術担当（主担当） | 〇〇 〇〇 | xxxx@example.com | 090-XXXX-XXXX |
| 技術担当（副担当） | 〇〇 〇〇 | xxxx@example.com | 090-XXXX-XXXX |
| 大会運営責任者 | 〇〇 〇〇 | xxxx@example.com | 090-XXXX-XXXX |
| Render/インフラ管理者 | 〇〇 〇〇 | xxxx@example.com | - |

### 障害発生時の連絡手順

1. **技術担当（主担当）** に電話連絡
2. 連絡が取れない場合は **副担当** へ
3. 大会当日は **運営責任者** にも同時連絡
4. Sentryで`[Nit-Sys] 障害発生`としてイシュー記録

---

## 定期メンテナンス

### 週次

- [ ] ログ確認
- [ ] ディスク使用量確認
- [ ] バックアップ確認

### 大会前

- [ ] 負荷テスト実施
- [ ] 全機能の動作確認
- [ ] バックアップ取得

### 大会後

- [ ] データエクスポート（記録保存用）
- [ ] 不要データのクリーンアップ
- [ ] パフォーマンスレビュー
