# 📋 Nit-Sys 開発 TODO リスト

**作成日:** 2025年11月27日  
**基準:** 日本体育大学長距離競技会 エントリー・運営管理システム 要件定義書

---

## 📊 実装状況サマリー

| カテゴリ | 完了 | 一部完了 | 未着手 | 達成率 |
|:---------|:----:|:--------:|:------:|:------:|
| ユーザー管理機能 | 8 | 0 | 0 | 100% |
| エントリー機能 | 5 | 1 | 0 | 92% |
| 決済・入金管理機能 | 15 | 0 | 0 | 100% |
| 車両・駐車場管理機能 | 10 | 1 | 0 | 95% |
| 自動番組編成機能 | 13 | 1 | 1 | 90% |
| 帳票・データ出力機能 | 6 | 0 | 0 | 100% |
| 当日受付・点呼フロー | 3 | 0 | 1 | 75% |
| 非機能要件 | 6 | 1 | 0 | 93% |
| お知らせ掲示板機能 | 4 | 0 | 0 | 100% |
| テスト | 1 | 0 | 2 | 33% |
| **合計** | **71** | **4** | **4** | **94%** |

---

## ✅ 凡例

- ✅ **完了** - 実装済み・動作確認済み
- 🔶 **一部完了** - 基本実装済み、追加作業が必要
- ❌ **未着手** - 未実装
- 🔧 **要修正** - 実装済みだが修正が必要

---

## 1. ユーザー管理機能 (3.1)

### 1.1 アカウント区分

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 1.1.1 | 管理者 (Superuser) アカウント作成 | ✅ | `User.is_admin`, `is_superuser` で実装済み |
| 1.1.2 | 一般ユーザー（団体代表者）登録 | ✅ | `register` ビューで団体登録対応 |
| 1.1.3 | 一般ユーザー（個人参加）登録 | ✅ | `is_individual` フラグで実装済み |
| 1.1.4 | ログイン機能（メールアドレス認証） | ✅ | `USERNAME_FIELD = 'email'` で実装済み |
| 1.1.5 | ログアウト機能 | ✅ | `CustomLogoutView` で実装済み |
| 1.1.6 | プロフィール編集機能 | ✅ | `profile_edit` ビューで実装済み |
| 1.1.7 | パスワードリセット機能 | ✅ | Django `PasswordResetView` で実装済み、テンプレート完備 |

### 1.2 選手マスタ管理

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 1.2.1 | 選手登録（氏名・フリガナ） | ✅ | `Athlete` モデルで実装済み |
| 1.2.2 | 選手登録（生年月日） | ✅ | `birth_date` フィールドで実装済み |
| 1.2.3 | 選手登録（陸連登録番号） | ✅ | `jaaf_id` フィールドで実装済み |
| 1.2.4 | 選手一覧表示 | ✅ | `AthleteListView` で実装済み |
| 1.2.5 | 選手編集機能 | ✅ | `AthleteUpdateView` で実装済み |
| 1.2.6 | 選手削除機能 | ✅ | `AthleteDeleteView` で実装済み |
| 1.2.7 | 過去大会から選手をリストから選択 | 🔶 | エントリー時に選択可能、UI改善の余地あり |

### 📝 TODO（ユーザー管理）

```markdown
- [x] パスワードリセット機能の実装
  - Django の PasswordResetView を使用
  - メール送信設定（SMTP）設定済み
  - テンプレート作成済み: password_reset.html, password_reset_done.html, password_reset_confirm.html, password_reset_complete.html

- [ ] 選手選択UIの改善
  - エントリーフォームでの選手検索機能強化
  - オートコンプリート（Ajax検索）の追加検討
```

---

## 2. エントリー機能 (3.2)

### 2.1 大会申込

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 2.1.1 | 大会一覧表示 | ✅ | `CompetitionListView` で実装済み |
| 2.1.2 | 種目選択 | ✅ | `entry_create` ビューで実装済み |
| 2.1.3 | 申告タイム（目標タイム）入力 | ✅ | `declared_time` フィールドで実装済み |
| 2.1.4 | 排他制御（DBトランザクション処理） | ✅ | `@transaction.atomic` で実装済み |
| 2.1.5 | エントリー期間制御 | ✅ | `Competition.can_entry` プロパティで実装済み |
| 2.1.6 | 定員チェック | ✅ | `Race.is_full` プロパティで実装済み |
| 2.1.7 | 性別チェック | ✅ | `Entry.clean()` で実装済み |

### 2.2 履歴参照

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 2.2.1 | ダッシュボード | ✅ | `dashboard` ビューで実装済み |
| 2.2.2 | 過去エントリー履歴表示 | 🔶 | テンプレートは存在、機能確認が必要 |
| 2.2.3 | 過去タイム参照 | 🔶 | `personal_best` フィールドあり、表示UIの確認が必要 |

### 📝 TODO（エントリー）

```markdown
- [ ] エントリー履歴画面の動作確認・改善
  - 過去大会のエントリー一覧表示
  - 結果タイムの表示（将来的な機能拡張）

- [ ] 複数選手一括エントリーUIの改善
  - CSVインポート機能の検討
  - 一括入力フォームの使いやすさ向上
```

---

## 3. 決済・入金管理機能 (3.3)

### 3.1 基本フロー（オンライン完結）

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 3.1.1 | 銀行振込のみ対応 | ✅ | 設計通り（クレジットカード決済なし） |
| 3.1.2 | 振込先口座情報管理 | ✅ | `BankAccount` モデルで実装済み |
| 3.1.3 | 振込明細画像アップロード | ✅ | `Payment.receipt_image` で実装済み |
| 3.1.4 | 画像リサイズ・保存 | ✅ | Pillow でパス生成実装済み |
| 3.1.5 | 管理者による入金確認画面 | ✅ | `payment_review.html` テンプレート存在 |
| 3.1.6 | 承認ボタン押下でエントリー確定 | ✅ | `Payment.approve()` メソッドで実装済み |
| 3.1.7 | 却下機能 | ✅ | `Payment.reject()` メソッドで実装済み |
| 3.1.8 | ステータス管理 | ✅ | pending → payment_uploaded → confirmed |

### 3.2 当日トラブル対応フロー（例外処理）

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 3.2.1 | 未払い選手の赤色表示 | ✅ | `checkin_search.html` で `payment-alert-row` クラス適用 |
| 3.2.2 | トラブルデスク誘導表示 | ✅ | 未払い選手に「会計へ誘導」メッセージ表示 |
| 3.2.3 | 強制承認機能 | ✅ | `Payment.force_approve()` メソッドで実装済み |
| 3.2.4 | 強制承認検索画面 | ✅ | `/payments/admin/force-approve/` で検索可能 |
| 3.2.5 | 強制承認のセキュリティログ | ✅ | `security` ロガーに記録 |

### 📝 TODO（決済）

```markdown
- [x] 当日トラブル対応フロー
  - 未払い選手の赤色表示
  - トラブルデスク誘導表示
  - 強制承認機能

- [ ] 入金確認メール通知機能
  - 承認時に申込者へ確認メール送信
  - 却下時の理由通知メール

- [ ] 入金一覧のフィルタリング・検索機能強化
  - ステータス別フィルター
  - 団体名検索
  - 日付範囲フィルター
```

---

## 3.5 車両・駐車場管理機能 (Parking Management)

### 3.5.1 申し込み（ユーザー側）

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 3.5.1.1 | 車両希望台数入力 | ✅ | `ParkingRequest` モデルで実装済み |
| 3.5.1.2 | 大型バス・中型バス・乗用車の区分 | ✅ | 各フィールドで管理 |
| 3.5.1.3 | 希望備考入力 | ✅ | `request_note` フィールドで実装 |

### 3.5.2 割り当て登録（管理者側）

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 3.5.2.1 | CSVインポート機能 | ✅ | `payments/parking_import.py` で実装 |
| 3.5.2.2 | 団体名の名寄せロジック | ✅ | 類似度検索で表記ゆれに対応 |
| 3.5.2.3 | インポートエラーログ | ✅ | 不一致時にエラー・候補表示 |
| 3.5.2.4 | 駐車場・入出庫時間の割当 | ✅ | `assigned_parking_lot`, `entry_time`, `exit_time` |

### 3.5.3 駐車証発行（出力）

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 3.5.3.1 | 駐車許可証PDF生成 | ✅ | `ParkingPermitPDFGenerator.generate_permit_pdf()` |
| 3.5.3.2 | 全団体一括PDF生成 | ✅ | `generate_all_permits_pdf()` で一括出力 |
| 3.5.3.3 | 許可証記載内容 | ✅ | 団体名、駐車場、入出庫時間、台数 |

### 📝 TODO（車両管理）

```markdown
- [x] ParkingRequest モデル作成
  - 希望台数（大型バス、中型バス、乗用車）
  - 割当情報（駐車場、入出庫時間）
  - ステータス管理

- [x] CSVインポート機能
  - pandas不要の純Python実装
  - 団体名の名寄せ（類似度検索）
  - エラー・警告ログ

- [x] 駐車許可証PDF生成
  - A4サイズ、日本語対応
  - 団体名・駐車場情報を大きく表示
  - 一括出力機能

- [ ] マイページへの駐車許可情報表示
  - 割当後にユーザー画面に表示
  - PDFダウンロードリンク
```

---

## 4. 自動番組編成機能 (3.4)

### 4.1 自動組分けロジック

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 4.1.1 | 申告タイム順ソート | ✅ | `HeatGenerator.generate_heats()` で実装済み |
| 4.1.2 | 1組あたりの最大人数設定 | ✅ | `Race.heat_capacity` で実装済み |
| 4.1.3 | 自動分割 | ✅ | `HeatGenerator` で実装済み |
| 4.1.4 | 組番号自動付与 | ✅ | `heat_number` で実装済み |
| 4.1.5 | 腰ナンバー（レーン番号）自動付与 | ✅ | `bib_number` で実装済み |

### 4.2 NCG（ネクストジェネレーションチャレンジ）対応

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 4.2.1 | NCG種目フラグ | ✅ | `Race.is_ncg` フィールドで実装済み |
| 4.2.2 | NCG定員設定 | ✅ | `Race.ncg_capacity`（デフォルト35名） |
| 4.2.3 | 標準記録設定 | ✅ | `Race.standard_time` (DecimalField) で実装済み |
| 4.2.4 | フォールバック先種目設定 | ✅ | `Race.fallback_race` (FK to self) で実装済み |
| 4.2.5 | 標準記録バリデーション | ✅ | `Entry.clean()` で申告タイムと標準記録を比較 |
| 4.2.6 | NCGエントリー自動振り分け | ✅ | `HeatGenerator.process_ncg_entries()` で実装済み |
| 4.2.7 | 定員超過時の一般組スライド | ✅ | 36位以降は自動でfallback_raceへ移動 |
| 4.2.8 | NCGスライド履歴記録 | ✅ | `Entry.moved_from_ncg`, `original_ncg_race` で追跡可能 |

### 4.3 選手情報拡張

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 4.3.1 | 国籍フィールド | ✅ | `Athlete.nationality` (3文字、デフォルト'JPN') |
| 4.3.2 | 国籍選択UI | ✅ | AthleteFormで主要国コード選択可能 |

### 4.4 手動調整

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 4.4.1 | 選手の組移動（Ajax） | 🔶 | `move_assignment` ビュー存在、UI確認が必要 |
| 4.4.2 | ドラッグ＆ドロップUI | ❌ | **未実装** - JavaScript実装が必要 |
| 4.4.3 | PM配置調整 | 🔶 | 手動移動で対応可能、専用UIなし |
| 4.4.4 | 大学ごとのバラつき調整 | 🔶 | 手動で対応可能、自動化機能なし |

### 📝 TODO（番組編成）

```markdown
- [x] NCG（ネクストジェネレーションチャレンジ）対応
  - NCG種目フラグ（is_ncg）実装済み
  - NCG定員（ncg_capacity = 35）実装済み
  - 標準記録（standard_time）実装済み
  - フォールバック先種目（fallback_race）実装済み
  - 標準記録バリデーション実装済み
  - 定員超過時の自動スライドロジック実装済み
  - スライド履歴追跡機能実装済み

- [x] 国籍フィールド対応
  - Athlete.nationality 追加（デフォルト: JPN）
  - AthleteFormで国籍選択可能

- [ ] ドラッグ＆ドロップUIの実装
  - JavaScript ライブラリ（SortableJS等）の導入
  - 組間での選手移動を視覚的に操作可能に
  - 腰ナンバーの自動再割り当て

- [ ] ペースメーカー（PM）配置機能
  - PM フラグの追加
  - PM を各組に均等配置するロジック

- [ ] 同一大学バラつき調整機能
  - 同じ大学の選手が同じ組に固まらないよう自動調整
  - 調整度合いの設定オプション
```

---

## 5. 帳票・データ出力機能 (3.5)

### 5.1 計測システム連携

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 5.1.1 | スタートリストCSV出力 | ✅ | `CSVGenerator.generate_startlist_csv()` で実装済み |
| 5.1.2 | FinishLynx/NISHI形式対応 | ✅ | 必要フィールド（Heat, Lane, Bib等）出力対応 |

### 5.2 運営用帳票（PDF）

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 5.2.1 | 一次点呼用リスト（PDF） | ✅ | ReportLab で実装済み |
| 5.2.2 | プログラム原稿（PDF） | ✅ | 組ごとの選手一覧出力対応 |
| 5.2.3 | 日本語フォント対応 | 🔶 | TTFont 登録コードあり、フォントファイルの配置確認が必要 |

### 5.3 緊急時対応

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 5.3.1 | 全データCSV出力 | ✅ | `generate_all_data_csv()` で実装済み |
| 5.3.2 | 全データPDF化（ローカル保存） | ❌ | **未実装** - 全競技会データの一括PDF化 |

### 📝 TODO（帳票出力）

```markdown
- [ ] 日本語フォント設定の確認
  - IPAフォント等の配置
  - settings.py でフォントパス設定

- [ ] 緊急用全データPDF出力機能
  - 大会全体のスタートリストを1つのPDFにまとめる
  - オフライン運用を想定した完全なデータ出力

- [ ] 帳票デザインの調整
  - ロゴ挿入
  - 印刷時の余白調整
```

---

## 6. 当日受付・点呼フロー (3.6)

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 6.1 | 氏名検索機能 | ✅ | `checkin_search.html` テンプレート存在 |
| 6.2 | 所属検索機能 | ✅ | 同上 |
| 6.3 | チェックイン処理 | ✅ | `HeatAssignment.checked_in` フラグで実装済み |
| 6.4 | チェックイン時刻記録 | ✅ | `checked_in_at` フィールドで実装済み |
| 6.5 | 欠場（DNS）登録 | ✅ | `HeatAssignment.status = 'dns'` で対応 |
| 6.6 | リアルタイム点呼状況表示 | ❌ | **未実装** - 管理画面での点呼進捗表示 |

### 📝 TODO（当日受付）

```markdown
- [ ] リアルタイム点呼状況ダッシュボード
  - 組ごとの点呼完了率表示
  - 未点呼選手のハイライト
  - 自動リフレッシュ（WebSocket または polling）

- [ ] タブレット向けUI最適化
  - タッチ操作に適したボタンサイズ
  - 高速検索のためのUI改善
```

---

## 7. 非機能要件 (Section 6)

### 7.1 セキュリティ

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 7.1.1 | HTTPS化（SSL/TLS） | ✅ | Render/Railway でSSL自動対応 |
| 7.1.2 | パスワードハッシュ化 | ✅ | Django 標準のハッシュ化機能使用 |
| 7.1.3 | CSRF対策 | ✅ | Django 標準の CsrfViewMiddleware 使用 |
| 7.1.4 | XSS対策 | ✅ | Django テンプレートエンジンの自動エスケープ |
| 7.1.5 | ログイン成功/失敗ログ記録 | ✅ | `accounts/signals.py` で実装済み |
| 7.1.6 | 認可エラーログ記録 | ✅ | `accounts/middleware.py`, `accounts/utils.py` で実装済み |
| 7.1.7 | セッションアイドルタイムアウト | ✅ | 30分で自動ログアウト（`SESSION_IDLE_TIMEOUT`）|

### 7.2 可用性

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 7.2.1 | PostgreSQL使用（トランザクション対応） | ✅ | settings.py で設定済み |
| 7.2.2 | 排他制御（同時アクセス対策） | ✅ | `@transaction.atomic` 使用 |
| 7.2.3 | スパイクアクセス対策 | 🔶 | PaaS 依存、キャッシュ設定の検討が必要 |

### 7.3 運用

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 7.3.1 | 環境変数による設定管理 | ✅ | python-decouple 使用 |
| 7.3.2 | 静的ファイル配信（WhiteNoise） | ✅ | 設定済み |
| 7.3.3 | 本番デプロイ設定（Render） | ✅ | render.yaml, Procfile 存在 |
| 7.3.4 | データベースバックアップ | ✅ | `scripts/backup_db.sh`, `scripts/restore_db.sh` 作成済み |
| 7.3.5 | セキュリティログ設定 | ✅ | `security` ロガー設定済み |

### 📝 TODO（非機能要件）

```markdown
- [ ] キャッシュ設定
  - Django のキャッシュフレームワーク設定
  - 静的コンテンツのキャッシュヘッダー設定

- [x] データベースバックアップスクリプト
  - scripts/backup_db.sh 作成済み
  - scripts/restore_db.sh 作成済み

- [x] セキュリティログ管理
  - ログイン成功/失敗のログ記録
  - 認可エラーのログ記録
  - セッションタイムアウトのログ記録

- [ ] パフォーマンス監視
  - レスポンスタイムの監視
  - エントリー開始時のスパイク対策確認
```

---

## 8. テスト

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 8.1 | ユニットテスト | ✅ | 84テスト作成済み（accounts, competitions, entries, heats, payments, reports） |
| 8.2 | 統合テスト | ❌ | **未作成** |
| 8.3 | E2Eテスト | ❌ | **未作成** |

### 📝 TODO（テスト）

```markdown
- [x] テスト環境のセットアップ
  - pytest-django インストール済み
  - pytest.ini 設定済み
  - conftest.py 設定済み

- [x] モデルのユニットテスト
  - accounts/tests.py (21テスト)
  - competitions/tests.py (7テスト)
  - entries/tests.py (2テスト)
  - heats/tests.py (21テスト) ← NCGテスト3件追加
  - payments/tests.py (12テスト) ← 駐車場・強制承認テスト8件追加
  - reports/tests.py (5テスト)

- [ ] ビューの統合テスト
  - エントリーフローのテスト
  - 決済フローのテスト
  - 番組編成のテスト

- [ ] CI/CD パイプライン
  - GitHub Actions でのテスト自動実行
```

---

## 10. 追加機能（2025年11月追加）

### 10.1 領収書自動発行機能

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 10.1.1 | 領収書PDF生成 | ✅ | ReportLabで実装済み |
| 10.1.2 | 発行条件（承認後のみ） | ✅ | ステータスチェック実装済み |
| 10.1.3 | 宛名自動印字（団体名） | ✅ | Organization.nameを使用 |
| 10.1.4 | 公印画像重ね表示 | ✅ | 透過PNG対応 |
| 10.1.5 | 管理番号発行 | ✅ | R-{大会ID}-{グループID}形式 |
| 10.1.6 | ダウンロードUI | ✅ | 支払い状態画面に配置 |

### 10.2 お知らせ掲示板機能

| # | 項目 | 状態 | 備考 |
|---|------|:----:|------|
| 10.2.1 | Newsモデル | ✅ | news/models.py |
| 10.2.2 | Django Admin投稿管理 | ✅ | news/admin.py |
| 10.2.3 | 重要フラグ（赤色表示） | ✅ | is_important フィールド |
| 10.2.4 | 公開/非公開設定 | ✅ | is_active フィールド |
| 10.2.5 | ダッシュボード表示 | ✅ | 最新5件表示 |
| 10.2.6 | 一覧・詳細ページ | ✅ | /news/ および /news/{pk}/ |

---

## 📌 優先度別 TODO まとめ

### 🔴 高優先度（本番運用前に必須）

1. [x] パスワードリセット機能 ✅
2. [ ] 日本語フォント設定の確認・修正
3. [x] テストの作成・実行 ✅ (83テスト作成済み)
4. [x] データベースバックアップ設定 ✅
5. [x] 領収書自動発行機能 ✅ (2025/11追加)
6. [x] お知らせ掲示板機能 ✅ (2025/11追加)

### 🟡 中優先度（運用開始後でも可）

7. [ ] ドラッグ＆ドロップUIの実装
8. [ ] リアルタイム点呼状況ダッシュボード
9. [ ] 入金確認メール通知機能
10. [ ] 緊急用全データPDF出力
11. [ ] お知らせ一斉メール送信（SendGrid連携）

### 🟢 低優先度（将来的な改善）

12. [ ] 選手選択UIの改善（オートコンプリート）
13. [ ] PM配置・大学バラつき自動調整
14. [ ] パフォーマンス監視
15. [ ] CI/CD パイプライン構築

---

## 📂 関連ドキュメント

| ドキュメント | 場所 |
|--------------|------|
| README.md | `/README.md` |
| データ管理ガイド | `/docs/データ管理ガイド.md` |
| 要件定義書 | （本ドキュメントの元となった要件） |

---

*最終更新: 2025年11月27日*
