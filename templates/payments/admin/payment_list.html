{% extends 'base.html' %}

{% block title %}入金確認一覧{% endblock %}

{% block extra_css %}
<style>
    /* 入金確認画面専用スタイル */
    .filter-tabs {
        background: white;
        border-radius: 0.5rem;
        padding: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .filter-tabs .btn {
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
        font-weight: 500;
    }
    .filter-tabs .btn-primary {
        box-shadow: 0 2px 4px rgba(43, 108, 176, 0.3);
    }
    
    /* 件数バッジ */
    .count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 1.5rem;
        height: 1.5rem;
        padding: 0 0.4rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 9999px;
        margin-left: 0.5rem;
    }
    .count-badge-pending {
        background-color: #fef3c7;
        color: #92400e;
    }
    .count-badge-approved {
        background-color: #d1fae5;
        color: #065f46;
    }
    
    /* 統計カード */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .stat-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem 1.25rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        text-align: center;
    }
    .stat-card .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1.2;
    }
    .stat-card .stat-label {
        font-size: 0.85rem;
        color: #718096;
        margin-top: 0.25rem;
    }
    .stat-card.pending .stat-value { color: #d69e2e; }
    .stat-card.approved .stat-value { color: #38a169; }
    .stat-card.total .stat-value { color: #2b6cb0; }
    
    /* テーブル改善 */
    .payment-table th {
        white-space: nowrap;
    }
    .payment-table .sortable {
        cursor: pointer;
    }
    .payment-table .sortable:hover {
        background-color: #edf2f7;
    }
    
    /* 行のホバー効果 */
    .payment-row {
        transition: all 0.15s ease;
    }
    .payment-row:hover {
        background-color: #ebf4ff !important;
    }
    .payment-row.pending {
        border-left: 4px solid #ecc94b;
    }
    .payment-row.approved {
        border-left: 4px solid #48bb78;
    }
    .payment-row.rejected {
        border-left: 4px solid #fc8181;
    }
    
    /* 確認ボタン */
    .btn-review {
        padding: 0.5rem 1rem;
        font-weight: 500;
    }
    .btn-review-urgent {
        animation: pulse-border 2s infinite;
    }
    @keyframes pulse-border {
        0%, 100% { box-shadow: 0 0 0 0 rgba(237, 137, 54, 0.4); }
        50% { box-shadow: 0 0 0 4px rgba(237, 137, 54, 0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h1><i class="bi bi-credit-card" aria-hidden="true"></i> 入金確認</h1>
    <div class="d-flex gap-2">
        <a href="{% url 'payments:force_approve_search' %}" class="btn btn-outline-secondary" title="ゼッケン番号などから直接承認">
            <i class="bi bi-search" aria-hidden="true"></i> 当日承認
        </a>
    </div>
</div>

<!-- 統計表示 -->
<div class="stats-row" role="region" aria-label="入金確認の統計">
    <div class="stat-card pending">
        <div class="stat-value">{{ pending_count|default:0 }}</div>
        <div class="stat-label"><i class="bi bi-hourglass-split" aria-hidden="true"></i> 確認待ち</div>
    </div>
    <div class="stat-card approved">
        <div class="stat-value">{{ approved_count|default:0 }}</div>
        <div class="stat-label"><i class="bi bi-check-circle" aria-hidden="true"></i> 本日承認</div>
    </div>
    <div class="stat-card total">
        <div class="stat-value">{{ total_amount|default:0 }}円</div>
        <div class="stat-label"><i class="bi bi-cash" aria-hidden="true"></i> 本日入金額</div>
    </div>
</div>

<!-- フィルタータブ -->
<div class="filter-tabs mb-4" role="tablist" aria-label="入金状態フィルター">
    <div class="btn-group" role="group">
        <a href="?status=pending" 
           class="btn {% if status_filter == 'pending' %}btn-primary{% else %}btn-outline-secondary{% endif %}"
           role="tab"
           aria-selected="{% if status_filter == 'pending' %}true{% else %}false{% endif %}">
            <i class="bi bi-hourglass-split" aria-hidden="true"></i> 確認待ち
            {% if pending_count %}<span class="count-badge count-badge-pending">{{ pending_count }}</span>{% endif %}
        </a>
        <a href="?status=approved" 
           class="btn {% if status_filter == 'approved' %}btn-primary{% else %}btn-outline-secondary{% endif %}"
           role="tab"
           aria-selected="{% if status_filter == 'approved' %}true{% else %}false{% endif %}">
            <i class="bi bi-check-circle" aria-hidden="true"></i> 承認済み
        </a>
        <a href="?status=rejected" 
           class="btn {% if status_filter == 'rejected' %}btn-primary{% else %}btn-outline-secondary{% endif %}"
           role="tab"
           aria-selected="{% if status_filter == 'rejected' %}true{% else %}false{% endif %}">
            <i class="bi bi-x-circle" aria-hidden="true"></i> 却下
        </a>
        <a href="?status=all" 
           class="btn {% if status_filter == 'all' %}btn-primary{% else %}btn-outline-secondary{% endif %}"
           role="tab"
           aria-selected="{% if status_filter == 'all' %}true{% else %}false{% endif %}">
            すべて
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        {% if payments %}
        <div class="table-responsive">
            <table class="table table-hover payment-table mb-0">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="date">
                            <i class="bi bi-calendar" aria-hidden="true"></i> アップロード日時
                        </th>
                        <th>団体/個人</th>
                        <th>大会</th>
                        <th class="text-center sortable" data-sort="count">件数</th>
                        <th class="text-end sortable" data-sort="amount">金額</th>
                        <th class="text-center">状態</th>
                        <th class="text-end" style="width: 120px;"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                    <tr class="payment-row {% if payment.status == 'approved' %}approved{% elif payment.status == 'rejected' %}rejected{% else %}pending{% endif %}">
                        <td>
                            <span class="fw-medium">{{ payment.uploaded_at|date:"m/d" }}</span>
                            <span class="text-muted">{{ payment.uploaded_at|time:"H:i" }}</span>
                        </td>
                        <td>
                            {% if payment.entry_group.organization %}
                                <i class="bi bi-building" aria-hidden="true"></i>
                                {{ payment.entry_group.organization.name }}
                            {% else %}
                                <i class="bi bi-person" aria-hidden="true"></i>
                                個人
                            {% endif %}
                        </td>
                        <td>
                            <span title="{{ payment.entry_group.competition.name }}">
                                {{ payment.entry_group.competition.name|truncatechars:25 }}
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-secondary">{{ payment.entry_group.entries.count }}件</span>
                        </td>
                        <td class="text-end fw-medium">
                            {{ payment.entry_group.total_amount|default:0 }}円
                        </td>
                        <td class="text-center">
                            {% if payment.status == 'approved' %}
                                <span class="badge badge-confirmed">
                                    <i class="bi bi-check-circle" aria-hidden="true"></i> 承認済み
                                </span>
                            {% elif payment.status == 'rejected' %}
                                <span class="badge badge-cancelled">
                                    <i class="bi bi-x-circle" aria-hidden="true"></i> 却下
                                </span>
                            {% else %}
                                <span class="badge badge-pending">
                                    <i class="bi bi-hourglass-split" aria-hidden="true"></i> 確認待ち
                                </span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <a href="{% url 'payments:admin_review' payment.pk %}" 
                               class="btn btn-sm btn-review {% if payment.status == 'pending' %}btn-primary btn-review-urgent{% else %}btn-outline-primary{% endif %}"
                               aria-label="{{ payment.entry_group.organization.name|default:'個人' }}の入金を確認">
                                <i class="bi bi-eye" aria-hidden="true"></i> 
                                {% if payment.status == 'pending' %}確認{% else %}詳細{% endif %}
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- ページネーション -->
        {% if payments.has_other_pages %}
        <nav class="p-3" aria-label="入金一覧のページネーション">
            <ul class="pagination justify-content-center mb-0">
                {% if payments.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ payments.previous_page_number }}&status={{ status_filter }}">
                            <i class="bi bi-chevron-left" aria-hidden="true"></i> 前へ
                        </a>
                    </li>
                {% endif %}
                
                <li class="page-item disabled">
                    <span class="page-link">{{ payments.number }} / {{ payments.paginator.num_pages }}</span>
                </li>
                
                {% if payments.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ payments.next_page_number }}&status={{ status_filter }}">
                            次へ <i class="bi bi-chevron-right" aria-hidden="true"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox display-1 text-muted" aria-hidden="true"></i>
            <p class="mt-3 text-muted fs-5">
                {% if status_filter == 'pending' %}
                    確認待ちの入金はありません
                {% elif status_filter == 'approved' %}
                    承認済みの入金はありません
                {% elif status_filter == 'rejected' %}
                    却下された入金はありません
                {% else %}
                    入金データがありません
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
