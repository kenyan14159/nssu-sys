{% extends 'base.html' %}

{% block title %}駐車場申請 - {{ competition.name }}{% endblock %}

{% block content %}
<div class="page-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'competitions:list' %}">大会一覧</a></li>
            <li class="breadcrumb-item"><a href="{% url 'competitions:detail' competition.pk %}">{{ competition.name }}</a></li>
            <li class="breadcrumb-item active">駐車場申請</li>
        </ol>
    </nav>
    <h1><i class="bi bi-car-front"></i> 駐車場申請</h1>
</div>

<div class="row">
    <div class="col-lg-8">
        {% if parking_request and parking_request.status == 'assigned' %}
        <!-- 割当済みの場合 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-check-circle"></i> 駐車場割当済み</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tbody>
                        <tr>
                            <th style="width: 200px;">申請団体</th>
                            <td>{{ parking_request.organization.name }}</td>
                        </tr>
                        <tr>
                            <th>大型バス</th>
                            <td>
                                希望: {{ parking_request.requested_large_bus }}台
                                → 割当: <strong class="text-success">{{ parking_request.assigned_large_bus }}台</strong>
                            </td>
                        </tr>
                        <tr>
                            <th>中型バス</th>
                            <td>
                                希望: {{ parking_request.requested_medium_bus }}台
                                → 割当: <strong class="text-success">{{ parking_request.assigned_medium_bus }}台</strong>
                            </td>
                        </tr>
                        <tr>
                            <th>乗用車</th>
                            <td>
                                希望: {{ parking_request.requested_car }}台
                                → 割当: <strong class="text-success">{{ parking_request.assigned_car }}台</strong>
                            </td>
                        </tr>
                        <tr>
                            <th>割当駐車場</th>
                            <td><strong class="text-primary fs-5">{{ parking_request.assigned_parking_lot }}</strong></td>
                        </tr>
                        <tr>
                            <th>入庫時間</th>
                            <td>{{ parking_request.entry_time|time:"H:i" }} 以降</td>
                        </tr>
                        <tr>
                            <th>出庫時間</th>
                            <td>{{ parking_request.exit_time|time:"H:i" }} まで</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="mt-4 text-center">
                    <a href="{% url 'payments:parking_permit_download' parking_request.pk %}" class="btn btn-primary btn-lg">
                        <i class="bi bi-file-pdf"></i> 駐車許可証をダウンロード
                    </a>
                    <p class="text-muted mt-2 small">
                        <i class="bi bi-info-circle"></i> 許可証はダッシュボードの見える位置に掲示してください。
                    </p>
                </div>
            </div>
        </div>

        {% elif parking_request and parking_request.status == 'rejected' %}
        <!-- 却下された場合 -->
        <div class="alert alert-danger mb-4">
            <h5><i class="bi bi-x-circle"></i> 駐車場申請が却下されました</h5>
            <p>申請内容をご確認の上、再度申請してください。</p>
        </div>
        
        <!-- 再申請フォーム -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pencil-square"></i> 駐車場を再申請</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="id_requested_large_bus" class="form-label">
                                <i class="bi bi-bus-front"></i> {{ form.requested_large_bus.label }}
                            </label>
                            {{ form.requested_large_bus }}
                            <div class="form-text">45人乗り以上</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_requested_medium_bus" class="form-label">
                                <i class="bi bi-truck"></i> {{ form.requested_medium_bus.label }}
                            </label>
                            {{ form.requested_medium_bus }}
                            <div class="form-text">マイクロバス等</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_requested_car" class="form-label">
                                <i class="bi bi-car-front"></i> {{ form.requested_car.label }}
                            </label>
                            {{ form.requested_car }}
                            <div class="form-text">普通乗用車</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_notes" class="form-label">{{ form.notes.label }}</label>
                        {{ form.notes }}
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-send"></i> 再申請を送信
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {% else %}
        <!-- 申請フォーム（新規 or 申請中） -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-pencil-square"></i>
                    {% if parking_request %}申請内容の変更{% else %}駐車場申請{% endif %}
                </h5>
                {% if parking_request %}
                <span class="badge bg-warning text-dark">申請中</span>
                {% endif %}
            </div>
            <div class="card-body">
                {% if parking_request %}
                <div class="alert alert-info mb-4">
                    <i class="bi bi-hourglass-split"></i>
                    現在、駐車場の割当を待っています。割当完了後、こちらから許可証をダウンロードできます。
                </div>
                {% endif %}
                
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="id_requested_large_bus" class="form-label">
                                <i class="bi bi-bus-front"></i> {{ form.requested_large_bus.label }}
                            </label>
                            {{ form.requested_large_bus }}
                            <div class="form-text">45人乗り以上</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_requested_medium_bus" class="form-label">
                                <i class="bi bi-truck"></i> {{ form.requested_medium_bus.label }}
                            </label>
                            {{ form.requested_medium_bus }}
                            <div class="form-text">マイクロバス等</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="id_requested_car" class="form-label">
                                <i class="bi bi-car-front"></i> {{ form.requested_car.label }}
                            </label>
                            {{ form.requested_car }}
                            <div class="form-text">普通乗用車</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_notes" class="form-label">{{ form.notes.label }}</label>
                        {{ form.notes }}
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-send"></i> 
                            {% if parking_request %}申請を更新{% else %}申請を送信{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> 駐車場について</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="bi bi-check text-success"></i>
                        駐車場は先着順ではなく、団体ごとに割り当てられます
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check text-success"></i>
                        割当が完了するとこちらから許可証をダウンロードできます
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        許可証は車両ダッシュボードに掲示してください
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        希望台数すべてが割り当てられない場合があります
                    </li>
                </ul>
            </div>
        </div>
        
        {% if parking_request %}
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> 申請履歴</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th>申請団体</th>
                        <td>{{ parking_request.organization.name }}</td>
                    </tr>
                    <tr>
                        <th>申請日時</th>
                        <td>{{ parking_request.created_at|date:"Y/m/d H:i" }}</td>
                    </tr>
                    <tr>
                        <th>ステータス</th>
                        <td>
                            {% if parking_request.status == 'assigned' %}
                            <span class="badge bg-success">割当済み</span>
                            {% elif parking_request.status == 'rejected' %}
                            <span class="badge bg-danger">却下</span>
                            {% else %}
                            <span class="badge bg-warning text-dark">申請中</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="mt-3">
    <a href="{% url 'competitions:detail' competition.pk %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> 大会詳細に戻る
    </a>
</div>
{% endblock %}
