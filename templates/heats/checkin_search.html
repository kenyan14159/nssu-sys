{% extends 'base.html' %}

{% block title %}受付・点呼{% endblock %}

{% block extra_css %}
<style>
    /* 点呼画面専用スタイル - 現場作業向け最適化 */
    .checkin-container {
        max-width: 100%;
    }
    
    .payment-alert-row {
        background-color: #f8d7da !important;
    }
    .payment-alert-row td {
        color: #721c24;
    }
    .payment-warning-badge {
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    .trouble-desk-alert {
        background-color: #f8d7da;
        border: 2px solid #f5c6cb;
        border-radius: 8px;
        padding: 10px;
    }
    
    /* 大きな検索ボックス */
    .search-box-large {
        font-size: 1.25rem;
        padding: 1rem 1.25rem;
        border-radius: 0.5rem;
    }
    .search-box-large::placeholder {
        color: #a0aec0;
    }
    
    /* 大きな点呼ボタン - タッチ操作向け */
    .btn-checkin {
        padding: 1rem 2rem;
        font-size: 1.25rem;
        font-weight: 600;
        min-width: 140px;
        border-radius: 0.5rem;
        touch-action: manipulation;
    }
    
    .btn-checkin-success {
        background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        border: none;
        color: white;
        box-shadow: 0 4px 6px rgba(56, 161, 105, 0.3);
    }
    .btn-checkin-success:hover,
    .btn-checkin-success:focus {
        background: linear-gradient(135deg, #2f855a 0%, #276749 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(56, 161, 105, 0.4);
    }
    .btn-checkin-success:active {
        transform: translateY(0);
    }
    
    .btn-dns {
        padding: 0.75rem 1.25rem;
        font-size: 1rem;
    }
    
    /* 結果カード - 大きく見やすく */
    .result-card {
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        transition: all 0.2s;
    }
    .result-card:hover {
        border-color: #cbd5e0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .result-card.checked-in {
        border-color: #68d391;
        background-color: #f0fff4;
    }
    .result-card.payment-alert {
        border-color: #fc8181;
        background-color: #fff5f5;
    }
    .result-card.dns {
        border-color: #a0aec0;
        background-color: #f7fafc;
        opacity: 0.7;
    }
    
    .result-card .athlete-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--nit-primary);
    }
    .result-card .bib-number {
        font-size: 2rem;
        font-weight: 800;
        color: var(--nit-accent);
        font-family: 'Monaco', 'Consolas', monospace;
    }
    .result-card .race-info {
        font-size: 1.1rem;
        color: #4a5568;
    }
    
    /* 点呼完了アニメーション */
    .checkin-success-animation {
        animation: checkinSuccess 0.5s ease-out;
    }
    @keyframes checkinSuccess {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); background-color: #c6f6d5; }
        100% { transform: scale(1); }
    }
    
    /* 統計バー */
    .stats-bar {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .stat-item {
        text-align: center;
    }
    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
    }
    .stat-label {
        font-size: 0.85rem;
        color: #718096;
    }
    
    /* モバイル最適化 */
    @media (max-width: 767.98px) {
        .result-card .athlete-name {
            font-size: 1.25rem;
        }
        .result-card .bib-number {
            font-size: 1.5rem;
        }
        .btn-checkin {
            width: 100%;
            padding: 1.25rem;
            font-size: 1.5rem;
        }
        .stats-bar {
            justify-content: space-around;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="checkin-container">
    <div class="page-header">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'competitions:detail' competition.pk %}">{{ competition.name }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">受付・点呼</li>
            </ol>
        </nav>
        <h1><i class="bi bi-person-check" aria-hidden="true"></i> 受付・点呼</h1>
    </div>

    <!-- 検索ボックス -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3" role="search">
                <div class="col-12">
                    <label for="searchInput" class="visually-hidden">氏名または所属で検索</label>
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-white"><i class="bi bi-search" aria-hidden="true"></i></span>
                        <input type="search" 
                               name="q" 
                               id="searchInput"
                               class="form-control search-box-large" 
                               placeholder="氏名・所属・ゼッケン番号で検索" 
                               value="{{ query }}" 
                               autofocus
                               autocomplete="off"
                               aria-label="検索キーワード">
                        <button type="submit" class="btn btn-primary btn-lg px-4">
                            <i class="bi bi-search" aria-hidden="true"></i> 検索
                        </button>
                    </div>
                    <div class="form-text mt-2">
                        <kbd>/</kbd> キーで検索ボックスにフォーカス
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if query %}
    <!-- 検索結果ヘッダー -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h5 class="mb-0">
            <i class="bi bi-list-check" aria-hidden="true"></i> 
            検索結果: 「{{ query }}」
            <span class="badge bg-primary">{{ results|length }}件</span>
        </h5>
        <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-danger payment-warning-badge" aria-label="入金未確認の選手は赤で表示されます">
                <i class="bi bi-exclamation-triangle" aria-hidden="true"></i> 赤 = 入金未確認
            </span>
            <span class="badge bg-success">
                <i class="bi bi-check-circle" aria-hidden="true"></i> 緑 = 点呼済み
            </span>
        </div>
    </div>

    {% if results %}
    <!-- カード形式の結果表示 -->
    <div class="row" role="list" aria-label="検索結果一覧">
        {% for assignment in results %}
        <div class="col-12 col-lg-6" role="listitem">
            <div class="result-card p-3 {% if assignment.entry.status == 'pending' or assignment.entry.status == 'payment_uploaded' %}payment-alert{% elif assignment.checked_in %}checked-in{% elif assignment.status == 'dns' %}dns{% endif %}" 
                 id="card-{{ assignment.pk }}"
                 data-assignment-id="{{ assignment.pk }}">
                <div class="row align-items-center">
                    <!-- ゼッケン番号 -->
                    <div class="col-auto">
                        <div class="bib-number" aria-label="ゼッケン番号">
                            #{{ assignment.bib_number|default:"---" }}
                        </div>
                    </div>
                    
                    <!-- 選手情報 -->
                    <div class="col">
                        <div class="athlete-name">{{ assignment.entry.athlete.full_name }}</div>
                        <div class="race-info">
                            <span class="badge bg-secondary me-1">{{ assignment.heat.race.name }}</span>
                            <span>{{ assignment.heat.heat_number }}組</span>
                            {% if assignment.entry.athlete.organization %}
                            <span class="text-muted">・{{ assignment.entry.athlete.organization.short_name }}</span>
                            {% endif %}
                        </div>
                        
                        <!-- ステータス表示 -->
                        <div class="mt-2 d-flex gap-2 flex-wrap">
                            {% if assignment.entry.status == 'confirmed' %}
                                <span class="badge bg-success"><i class="bi bi-credit-card" aria-hidden="true"></i> 入金済</span>
                            {% elif assignment.entry.status == 'payment_uploaded' %}
                                <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split" aria-hidden="true"></i> 入金確認中</span>
                            {% else %}
                                <span class="badge bg-danger"><i class="bi bi-x-circle" aria-hidden="true"></i> 未払い</span>
                            {% endif %}
                            
                            {% if assignment.checked_in %}
                                <span class="badge bg-success"><i class="bi bi-check-circle" aria-hidden="true"></i> 点呼済 {{ assignment.checked_in_at|time:"H:i" }}</span>
                            {% elif assignment.status == 'dns' %}
                                <span class="badge bg-danger">DNS</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- アクションボタン -->
                    <div class="col-12 col-sm-auto mt-3 mt-sm-0">
                        {% if assignment.entry.status != 'confirmed' %}
                            <div class="trouble-desk-alert text-center">
                                <strong><i class="bi bi-exclamation-triangle" aria-hidden="true"></i> 入金未確認</strong>
                                <p class="mb-0 small">トラブルデスク（会計）へ</p>
                            </div>
                        {% elif not assignment.checked_in and assignment.status != 'dns' %}
                            <form action="{% url 'heats:checkin' assignment_pk=assignment.pk %}" 
                                  method="post" 
                                  class="checkin-form d-flex flex-column gap-2">
                                {% csrf_token %}
                                <input type="hidden" name="redirect_query" value="{{ query }}">
                                <button type="submit" 
                                        class="btn btn-checkin btn-checkin-success"
                                        aria-label="{{ assignment.entry.athlete.full_name }}の点呼を完了">
                                    <i class="bi bi-check-lg" aria-hidden="true"></i> 点呼
                                </button>
                            </form>
                        {% elif assignment.checked_in %}
                            <div class="text-center">
                                <i class="bi bi-check-circle-fill text-success" style="font-size: 2.5rem;" aria-hidden="true"></i>
                                <div class="text-success fw-bold">完了</div>
                            </div>
                        {% elif assignment.status == 'dns' %}
                            <div class="text-center">
                                <span class="badge bg-secondary fs-6 p-2">DNS</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-search display-1 text-muted" aria-hidden="true"></i>
            <p class="mt-3 text-muted fs-5">「{{ query }}」に該当する選手が見つかりませんでした</p>
            <p class="text-muted">氏名、所属名、ゼッケン番号で検索できます</p>
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-person-badge display-1 text-muted" aria-hidden="true"></i>
            <p class="mt-3 fs-5">選手を検索してください</p>
            <p class="text-muted">氏名・所属名・ゼッケン番号で検索できます</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';
    
    // 点呼完了時のフィードバック
    document.querySelectorAll('.checkin-form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            const card = form.closest('.result-card');
            const btn = form.querySelector('.btn-checkin');
            
            // ボタンをローディング状態に
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>処理中...';
            
            // カードにアニメーションクラスを追加
            card.classList.add('checkin-success-animation');
        });
    });
    
    // 検索ボックスのフォーカス維持
    const searchInput = document.getElementById('searchInput');
    if (searchInput && searchInput.value) {
        // 検索後もフォーカスを維持（次の検索のため）
        searchInput.select();
    }
    
    // 音声フィードバック（対応ブラウザのみ）
    if ('speechSynthesis' in window) {
        document.querySelectorAll('.checkin-form').forEach(function(form) {
            form.addEventListener('submit', function() {
                // 簡単な音声フィードバック（オプション）
                // const utterance = new SpeechSynthesisUtterance('点呼完了');
                // utterance.lang = 'ja-JP';
                // speechSynthesis.speak(utterance);
            });
        });
    }
})();
</script>
{% endblock %}
